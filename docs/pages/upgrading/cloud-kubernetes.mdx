---
title: Upgrade Teleport Cloud Agents on Kubernetes
description: Provides instructions for upgrading Teleport Cloud agents that run on Kubernetes. 
---

This guide explains how to upgrade Teleport Cloud agents running on Kubernetes.
To keep agents up to date, you can either perform:
- [Automatic updates](#automatic-updates) (recommended)
- [Manual updates](#manual-updates)

## Prerequisites

- Familiarity with the [Upgrading Compatibility Overview](./overview.mdx) guide,
  which describes the sequence in which to upgrade components of your cluster.

- (!docs/pages/includes/cloud/tctl-tsh-prerequisite.mdx!)

- (!docs/pages/includes/tctl.mdx!)

## Check for agent updates

The latest compatible Teleport agent version is served by the Teleport Proxy. To
identify what that version is, you can query the `webapi` endpoint.
```code
$ curl https://<Var name="teleport.example.com" />/webapi/automaticupgrades/channel/stable/cloud/version
v15.2.1
```

To list the agents that are upgradable, use the `tctl inventory ls` command to list
the inventory of connected agents. The agents are listed along with their current
version. Additional flags are available to filter by service `--services=node,kube,db,...`,
or to filter by version `--older-than=v15.2.1`.
```code
$ tctl inventory ls --older-than=v15.2.1
Server ID                            Hostname       Services       Version Upgrader
------------------------------------ -------------- -------------- ------- --------
00000000-0000-0000-0000-000000000000 teleport-agent Kube           v14.4.5 none
00000000-0000-0000-0000-000000000001 teleport-proxy Proxy          v15.2.0 none
00000000-0000-0000-0000-000000000002 teleport-auth  Auth,Discovery v15.2.0 none
...
```
Note that the `inventory ls` command will also list `teleport-auth` and `teleport-proxy`
services. These services are managed by the Teleport Cloud team and updates will
be performed automatically.

## Automatic updates

Agents enrolled in automatic updates will automatically be kept up to date with the
latest compatible version of Teleport. You can find more information regarding the
automatic updates architecture in the [Agent Update Management](../architecture/agent-update-management.mdx)
page.

Automatic updates is not enabled by default for Helm releases. The `teleport-kube-agent`
Helm chart values must be configured to enable automatic updates. For more details
see the `teleport-kube-agent` [chart reference](../reference/helm-reference/teleport-kube-agent.mdx#updater).

### Find agents to enroll in automatic updates

To identify the agents that are not enrolled in automatic updates, use the `tctl inventory ls`
command again. The command accepts an additional `--upgrader=none` flag that can
be used to filter only the agents that are not enrolled in automatic updates.
```code
$ tctl inventory ls --upgrader=none
Server ID                            Hostname       Services       Version Upgrader
------------------------------------ -------------- -------------- ------- --------
00000000-0000-0000-0000-000000000000 teleport-agent Kube           v14.4.5 none
...
```

### Enroll agents in automatic updates

This section assumes that the name of your `teleport-kube-agent` release is
`teleport-agent`, and that you have installed it in the `teleport` namespace.

(!docs/pages/kubernetes-access/helm/includes/helm-repo-add.mdx!)

Add the following chart values to your existing agent `values.yaml` to enable
the automatic updater:

```yaml
updater:
    enabled: true
```

Upgrade the Helm chart release with the new values by running `helm upgrade`:

```code
$  helm -n <Var name="teleport" /> upgrade <Var name="teleport-agent" /> teleport/teleport-kube-agent  \
--values=values.yaml \
--version=<Var name="(=cloud.version=)" />
```

## Manual updates

[Automatic updates](#automatic-updates) is the recommended update method for Teleport
agents. If you choose to opt out of automatic updates, you will need to be responsible
for keeping your Teleport agents up to date with the version of Teleport Cloud.

(!docs/pages/kubernetes-access/helm/includes/helm-repo-add.mdx!)

Upgrade the Helm release:

```code
$ helm -n <Var name="teleport" /> upgrade <Var name="teleport-agent" /> teleport/teleport-kube-agent \
--values=values.yaml \
--version=<Var name="(=cloud.version=)" />
```

## FAQ

### ArgoCD deployments

Automatic updates is not currently compatible with ArgoCD deployments. The Helm chart
owns the version of the `teleport-agent` resource, so when the `teleport-agent-updater`
modifies the image version of the `teleport-agent` resource, ArgoCD reports the `teleport-agent`
resource as `OutOfSync`.

As a workaround to this problem use a [Diff Customization](https://argo-cd.readthedocs.io/en/stable/user-guide/diffing/#diffing-customization)
to ignore the difference in image version. This can be done by ignoring differences
of the `image` field. Here is an example deployment using the name `teleport-agent`
and namespace `teleport`.

```yaml
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: teleport-agent
spec
  ignoreDifferences:
  - group: apps
    kind: StatefulSet
    name: teleport-agent
    namespace: teleport
    jqPathExpressions:
    - .spec.template.spec.containers[] | select(.name == "teleport").image
...
```

### Automatic updates with Teleport OSS

Automatic updates is not currently supported with OSS editions of Teleport. Ensure
that you are using the Teleport Enterprise edition of the `teleport-kube-agent`
chart. You should see the following when you query your `teleport-kube-agent` release:

```code
$ helm -n <Var name="teleport" /> get values <Var name="teleport-agent" /> -o json | jq '.enterprise'
true
```

## Troubleshooting

Teleport agents are not updated immediately when a new version of Teleport is released,
and agent updates can lag behind the cluster by a few days.

If the Teleport agent has not been automatically updating for several weeks, you
can consult the updater logs to help troubleshoot the problem.

Validate that the updater pod is running:

```code
$ kubectl -n <Var name="teleport" /> get pods
NAME                                     READY   STATUS    RESTARTS   AGE
teleport-agent-0                         1/1     Running   0          14m
teleport-agent-1                         1/1     Running   0          14m
teleport-agent-2                         1/1     Running   0          14m
teleport-agent-updater-d9f97f5dd-v57g9   1/1     Running   0          16m
```

View its logs:

```code
$ kubectl -n <Var name="teleport" /> logs deployment/<Var name="teleport-agent" />-updater
2023-04-28T13:13:30Z	INFO	StatefulSet is already up-to-date, not updating.	{"controller": "statefulset", "controllerGroup": "apps", "controllerKind": "StatefulSet", "StatefulSet": {"name":"teleport-agent","namespace":"teleport"}, "namespace": "teleport", "name": "teleport-agent", "reconcileID": "10419f20-a4c9-45d4-a16f-406866b7fc05", "namespacedname": "teleport/teleport-agent", "kind": "StatefulSet", "err": "no new version (current: \"v12.2.3\", next: \"v12.2.3\")"}
```

The updater is a controller that periodically reconciles expected Kubernetes
resources with those in the cluster. The updater executes a reconciliation loop
every 30 minutes or in response to a Kubernetes event. If you don't want to wait
until the next reconciliation, you can trigger an event. Any deployment update
will send an event, so the updater can be triggered by annotating the resource:

```code
$ kubectl -n <Var name="teleport" /> annotate statefulset/<Var name="teleport-agent" /> 'debug.teleport.dev/trigger-event=1'
```

To suspend automatic updates for an agent, annotate the agent deployment with
`teleport.dev/skipreconcile: "true"`, either by setting the
`annotations.deployment` value in Helm, or by patching the deployment directly
with `kubectl`.
