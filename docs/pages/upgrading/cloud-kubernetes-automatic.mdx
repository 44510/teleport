---
title: Enable Automatic Updates for Cloud Agents on Kubernetes
description: Provides instructions for enabling automatic updates for Teleport Cloud agents that run on Kubernetes. 
---

This guide explains how to enable Automatic Updates for Teleport Cloud agents on
Kubernetes.

## Prerequisites

- Familiarity with the [Upgrading Compatibility Overview](./overview.mdx) guide,
  which describes the sequence in which to upgrade components of your cluster.

- (!docs/pages/includes/cloud/tctl-tsh-prerequisite.mdx!)

- (!docs/pages/includes/tctl.mdx!)

## Step 1/2. Find agents to enroll in automatic updates

Use the `tctl inventory ls` command to list connected agents along with their current
version. Use the `--upgrader=none` flag to list agents that are not enrolled in automatic
updates.

```code
$ tctl inventory ls --upgrader=none
Server ID                            Hostname       Services       Version Upgrader
------------------------------------ -------------- -------------- ------- --------
00000000-0000-0000-0000-000000000000 teleport-agent Kube           v14.4.5 none
...
```

Note that the `inventory ls` command will also list `teleport-auth` and `teleport-proxy`
services. These services are managed by the Teleport Cloud team and updates will
be performed automatically.

## Step 2/2. Enroll agents in automatic updates

This section assumes that the name of your `teleport-kube-agent` release is
`teleport-agent`, and that you have installed it in the `teleport` namespace.

(!docs/pages/kubernetes-access/helm/includes/helm-repo-add.mdx!)

Add the following chart values to your existing agent `values.yaml` to enable
the automatic updater:

```yaml
updater:
    enabled: true
```

Upgrade the Helm chart release with the new values by running `helm upgrade`:

```code
$  helm -n <Var name="teleport" /> upgrade <Var name="teleport-agent" /> teleport/teleport-kube-agent  \
--values=values.yaml \
--version=<Var name="(=cloud.version=)" />
```

## GitOps

Automatic updates are incompatible with some GitOps tools used for continuous deployment.
The `teleport-kube-agent` Helm chart owns the version of the `teleport-agent` resource,
so when the `teleport-agent-updater` modifies the image version of the `teleport-agent`
resource, the GitOps tool will detect a drift or a diff in the `teleport-agent` resource.

### ArgoCD deployments

After an automatic update, ArgoCD reports the `teleport-agent` resource as `OutOfSync`.
As a workaround to this problem use a [Diff Customization](https://argo-cd.readthedocs.io/en/stable/user-guide/diffing/#diffing-customization)
to ignore the difference in image version. Here is an example deployment using the
name `teleport-agent` and namespace `teleport`.

```yaml
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: teleport-agent
  namespace: teleport
spec
  ignoreDifferences:
  - group: apps
    kind: StatefulSet
    name: teleport-agent
    namespace: teleport
    jqPathExpressions:
    - .spec.template.spec.containers[] | select(.name == "teleport").image
...
```

### FluxCD deployments

After an automatic update, FluxCD reports a `DriftDetected` event. As a workaround
to this problem modify the [drift detection](https://fluxcd.io/flux/components/helm/helmreleases/#drift-detection)
configuration to ignore the difference in image version. Here is an example deployment
using the name `teleport-agent` and namespace `teleport`.

```yaml
apiVersion: helm.toolkit.fluxcd.io/v2beta2
kind: HelmRelease
metadata:
  name: teleport-agent
  namespace: teleport
spec
  driftDetection:
    mode: enabled
    ignore:
    - paths: ["/spec/template/spec/containers/0/image"]
      target:
        kind: StatefulSet
        name: teleport-agent
        namespace: teleport
...
```

## Automatic updates with Teleport OSS

Automatic updates is not currently supported with OSS editions of Teleport. Ensure
that you are using the Teleport Enterprise edition of the `teleport-kube-agent`
chart. You should see the following when you query your `teleport-kube-agent` release:

```code
$ helm -n <Var name="teleport" /> get values <Var name="teleport-agent" /> -o json | jq '.enterprise'
true
```

## Troubleshooting

Teleport agents are not updated immediately when a new version of Teleport is released,
and agent updates can lag behind the cluster by a few days.

If the Teleport agent has not been automatically updating for several weeks, you
can consult the updater logs to help troubleshoot the problem.

Validate that the updater pod is running:

```code
$ kubectl -n <Var name="teleport" /> get pods
NAME                                     READY   STATUS    RESTARTS   AGE
teleport-agent-0                         1/1     Running   0          14m
teleport-agent-1                         1/1     Running   0          14m
teleport-agent-2                         1/1     Running   0          14m
teleport-agent-updater-d9f97f5dd-v57g9   1/1     Running   0          16m
```

View its logs:

```code
$ kubectl -n <Var name="teleport" /> logs deployment/<Var name="teleport-agent" />-updater
2023-04-28T13:13:30Z	INFO	StatefulSet is already up-to-date, not updating.	{"controller": "statefulset", "controllerGroup": "apps", "controllerKind": "StatefulSet", "StatefulSet": {"name":"teleport-agent","namespace":"teleport"}, "namespace": "teleport", "name": "teleport-agent", "reconcileID": "10419f20-a4c9-45d4-a16f-406866b7fc05", "namespacedname": "teleport/teleport-agent", "kind": "StatefulSet", "err": "no new version (current: \"v12.2.3\", next: \"v12.2.3\")"}
```

The updater is a controller that periodically reconciles expected Kubernetes
resources with those in the cluster. The updater executes a reconciliation loop
every 30 minutes or in response to a Kubernetes event. If you don't want to wait
until the next reconciliation, you can trigger an event. Any deployment update
will send an event, so the updater can be triggered by annotating the resource:

```code
$ kubectl -n <Var name="teleport" /> annotate statefulset/<Var name="teleport-agent" /> 'debug.teleport.dev/trigger-event=1'
```

To suspend automatic updates for an agent, annotate the agent deployment with
`teleport.dev/skipreconcile: "true"`, either by setting the
`annotations.deployment` value in Helm, or by patching the deployment directly
with `kubectl`.

## Further reading

- [teleport-kube-agent Chart Reference](../reference/helm-reference/teleport-kube-agent.mdx#updater)
