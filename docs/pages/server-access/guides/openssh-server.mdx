---
title: Using Teleport with sshd
description: How to join sshd servers to a Teleport cluster.
videoBanner: x0eYFUEIOrM
---

In this guide, we will show you how to configure the OpenSSH server `sshd` to
join a Teleport cluster. Existing fleets of OpenSSH servers can be configured to
accept SSH certificates dynamically issued by a Teleport CA.

Using Teleport and OpenSSH has the advantage of getting you up
and running, but in the long run, we would recommend replacing `sshd` with `teleport`.
We've outlined these reasons in [OpenSSH vs Teleport SSH for Servers?](https://gravitational.com/blog/openssh-vs-teleport/)

## Prerequisites

- A Linux host with the OpenSSH server `sshd` installed.

(!docs/pages/includes/edition-prereqs-tabs.mdx!)

(!docs/pages/includes/tctl.mdx!)

## Step 1/3. Configure `sshd` to trust the Teleport CA

`sshd` must be told to allow users to log in with certificates generated by the
Teleport Auth Service. Start by exporting the Teleport CA public key.

Print the Teleport certificate authority certificate to stdout:

```code
$ tctl auth export --type=user | sed "s/cert-authority\ //"
```

Copy the output. On the host where you are running `sshd`, run the following commands.

Assign the output of the `tctl auth export` command to an environment variable:

```code
$ export KEY="<pasted output>"
```

Make the public key accessible to `sshd`:

```code
$ sudo bash -c "echo \"$KEY\" > /etc/ssh/teleport_user_ca.pub"
$ sudo bash -c "echo 'TrustedUserCAKeys /etc/ssh/teleport_user_ca.pub' >> /etc/ssh/sshd_config"
```

Restart `sshd`. For systemd-enabled hosts, run the following command:

```code
$ sudo systemctl restart sshd
```

Now, `sshd` will trust users who present a Teleport-issued certificate.

## Step 2/3. Configure host authentication

Next, ask Teleport to issue valid host certificates for your `sshd` host. 

On <ScopedBlock scope="cloud">your local machine</ScopedBlock><ScopedBlock scope={["oss", "enterprise"]}>your Auth Service host</ScopedBlock>, change the
IP address or fully qualified domain name of your Node to an environment
variable.

```code
$ ADDR=203.0.113.0
```

Run the following `tctl` command to generate a host certificate:

```code
$ sudo tctl auth sign \
      --host=${ADDR?} \
      --format=openssh \
      --out=stdout
```

To generate certificates for multiple hosts, assign the `host` flag to a
comma-separated list of addresses. Certificates for wildcard domains are not
supported by OpenSSH, so each domain must be fully qualified.

{/* TODO: Resume here after determining if I can generate a host cert in Cloud */}


```
# You can use ssh-keygen to verify the contents.
$ ssh-keygen -L -f api.example.com-cert.pub
#api.example.com-cert.pub:
#        Type: ssh-rsa-cert-v01@openssh.com host certificate
#        Public key: RSA-CERT SHA256:ireEc5HWFjhYPUhmztaFud7EgsopO8l+GpxNMd3wMSk
#        Signing CA: RSA SHA256:/6HSHsoU5u+r85M26Ut+M9gl+HventwSwrbTvP/cmvo
#        Key ID: ""
#        Serial: 0
#        Valid: after 2020-07-29T20:26:24
#        Principals:
#               api.example.com
#               ssh.example.com
#               64.225.88.175
#               64.225.88.178
#        Critical Options: (none)
#        Extensions:
#                x-teleport-authority UNKNOWN OPTION (len 47)
#                x-teleport-role UNKNOWN OPTION (len 8)
```

Then add the following lines to `/etc/ssh/sshd_config` on all OpenSSH nodes, and
restart `sshd`.

```yaml
HostKey /etc/ssh/api.example.com
HostCertificate /etc/ssh/api.example.com-cert.pub
```

## Step 3 /. Connect to the OpenSSH server

{/* TODO: Add a step showing how you'd connect to the host after going through
the previous steps */}

## Revoke an SSH certificate

{/* TODO: See if there's a better place to put this text */}

To revoke the current Teleport CA and generate a new one, run `tctl auth rotate`. Unless you've highly automated your
infrastructure, we would suggest you proceed with caution as this will invalidate the user
and host CAs, meaning that the new CAs will need to be exported to every OpenSSH-based machine again using `tctl auth export` as above.