---
title: Using Teleport with OpenSSH Clients
description: How to use Teleport on legacy systems with OpenSSH clients.
videoBanner: x0eYFUEIOrM
---

Teleport is a standards-compliant SSH proxy and can work in environments that
use legacy SSH implementations, such as OpenSSH, to access infrastructure.

In this guide, we will explain how to configure the OpenSSH client `ssh` to log
in to Nodes inside a Teleport cluster.

Using Teleport with OpenSSH has the advantage of getting you up and running, but
in the long run, we would recommend replacing `sshd` with `teleport`. We've
outlined our reasoning in
[OpenSSH vs Teleport SSH for Servers?](https://gravitational.com/blog/openssh-vs-teleport/).

## Prerequisites

- OpenSSH version 6.9 or above on your local machine. View your OpenSSH version
  with the command:
  
  ```code
  $ ssh -V
  ```

  You'll be editing your OpenSSH client configuration, so you may want to run
  the OpenSSH client from a local container or virtual machine.

(!docs/pages/includes/edition-prereqs-tabs.mdx!)

- A Linux host where you will install and run a Teleport Node.

(!docs/pages/includes/tctl.mdx!)

## Step 1/3. Prepare your Node

<ScopedBlock scope={["oss", "enterprise"]}>

On the host where you will run your Teleport Node, follow the instructions for
your environment to install Teleport.

(!docs/pages/includes/install-linux.mdx!)

</ScopedBlock>
<ScopedBlock scope={["cloud"]}>

(!docs/pages/includes/install-agent-cloud.mdx!)

</ScopedBlock>

<ScopedBlock scope="cloud">On your local machine, use</ScopedBlock><ScopedBlock
scope={["oss", "enterprise"]}>On the host that runs the Teleport Auth Service,
use</ScopedBlock> the `tctl` tool to generate an invite token that your Node
will use to join the cluster. In the following example, a new token is created
with a TTL of five minutes:

```code
# Generate a short-lived invitation token for a new node:
$ tctl nodes add --ttl=5m --roles=node
# The invite token: (=presets.tokens.first=)
# You can also list all generated non-expired tokens:
$ tctl tokens ls
# Token                            Type            Expiry Time
# ------------------------         -----------     ---------------
# (=presets.tokens.first=)         Node            25 Sep 18 00:21 UTC
```

On the host where you will run your Node, execute the following commands.

Assign your invite token and the
address of your <ScopedBlock scope="cloud">Teleport Cloud
tenant</ScopedBlock><ScopedBlock scope={["oss", "enterprise"]}>Teleport Auth
Service</ScopedBlock> to environment variables:

<ScopedBlock scope={["oss", "enterprise"]}>

```code
# Include the port used by your Auth Service to listen for connections
$ ADDR=tele.example.com:3025
$ TOKEN=<your token from above>
```

</ScopedBlock>
<ScopedBlock scope={["cloud"]}>

```code
# You must include port 443
$ ADDR=mytenant.teleport.sh:443
$ TOKEN=<your token from above>
```

</ScopedBlock>

Start Teleport with the invite token:

```code
$ sudo teleport start \
  --auth-server=${ADDR?} \
  --roles=node \
  --token=${TOKEN?}
```

Verify that your Node has started by running `tsh ls` on your local machine:

```code
$ tsh ls
Node Name        Address    Labels 
---------------- ---------- ------ 
ip-172-30-50-106 ⟵ Tunnel          
```

## Step 2/3. Generate an SSH client configuration

To use your OpenSSH client with Teleport, you will first generate a
configuration that the client will use to connect to the Teleport Proxy Service
and forward traffic to your Node.

First, make sure you are running OpenSSH's `ssh-agent` and have logged
in to your Teleport cluster:

<ScopedBlock scope={["oss","enterprise"]}>

```code
$ eval `ssh-agent`
$ tsh --proxy=root.example.com --user=myuser@example.com login
```

</ScopedBlock>
<ScopedBlock scope={["cloud"]}>

```code
$ eval `ssh-agent`
$ tsh --proxy=mytenant.teleport.sh --user=myuser@example.com login
```

</ScopedBlock>

The `ssh-agent` command prints additional commands to export the `SSH_AUTH_SOCK`
and `SSH_AGENT_PID` environment variables. These variables allow OpenSSH clients
to find the SSH agent. Running `ssh-agent` with `eval` executes these commands.

On your local machine, run the following `tsh` command. This will print the
necessary configuration to connect to a Node using the standard OpenSSH client:

```code
$ tsh config
```

If you are using Trusted Clusters, this will print an OpenSSH client
configuration block for the root cluster and all currently known leaf clusters.

<Details title="How does the config work?">

Teleport implements an SSH server that includes several **subsystems**, or
predefined commands that are run when the server handles a connection. The Proxy
Service implements a `proxy` subsystem that forwards SSH traffic to remote Nodes
and Trusted Clusters.

Here is a brief explanation of the configuration that `tsh config` generates:

```
# Common flags for all {{ .ClusterName }} hosts
Host *.{{ .ClusterName }} {{ .ProxyHost }}
    UserKnownHostsFile "{{ .KnownHostsPath }}"
    IdentityFile "{{ .IdentityFilePath }}"
    CertificateFile "{{ .CertificateFilePath }}"
```

If the host you are `ssh`ing into belongs to your Teleport cluster, use a
Teleport-managed known hosts file, private key, and certificate that are stored
in the `.tsh` directory.

```
# Flags for all {{ .ClusterName }} hosts except the proxy
Host *.{{ .ClusterName }} !{{ .ProxyHost }}
    Port 3022
    ProxyCommand "{{ .TSHPath }}" proxy ssh --cluster={{ .ClusterName }} --proxy={{ .ProxyHost }} %r@%h:%p
```

If the host that you are `ssh`ing into is a Node, the OpenSSH client will first
execute a command, the `ProxyCommand`, that makes an SSH connection to the Proxy
Service. This command, `tsh proxy ssh`, requests the `proxy` subsystem in order
to forward SSH traffic through the Proxy Service to your chosen Node (including
a Node in a Trusted Cluster).

</Details>

Append this to your local OpenSSH config file (usually `~/.ssh/config`) using
your text editor of choice.

<Details title="Using PowerShell on Windows?" opened={false}>

  If using PowerShell on Windows, note that normal shell redirection may write
  the file with the incorrect encoding. To ensure it's written properly, try the
  following:

  ```code
  $ tsh.exe config | out-file .ssh\config -encoding utf8 -append
  ```

</Details>

<Admonition
  type="tip"
  title="Multiple Clusters"
>

  If you switch between multiple Teleport Proxy Servers, you'll need to re-run
  `tsh config` for each to generate the cluster-specific configuration.

  Similarly, if Trusted Clusters are added or removed, be sure to re-run
  `tsh config` and replace the previous configuration.

</Admonition>

## Step 3/3. Connect to a Node

<ScopedBlock scope={["oss", "enterprise"]}>

Once you have appended the new text to your OpenSSH client configuration file,
you can log in to a Node in your Teleport cluster:

```code
# See which Nodes are available to access
$ tsh ls
Node Name        Address    Labels 
---------------- ---------- ------ 
node1 ⟵ Tunnel
# Use your Node's name as a subdomain of your Teleport Proxy Service's domain.
$ ssh user@node1.root.example.com
```

This will connect to the node `node1` on the `root.example.com` cluster. This
name does not need to be DNS accessible as the connection will be routed through
your Teleport Proxy Service.

If any Trusted Clusters exist, they are also configured:

```code
$ ssh user@node2.leaf.example.com
```

When connecting to Nodes with Teleport daemons running on non-standard ports
(other than `3022`), a port may be specified:

```code
$ ssh -p 4022 user@node3.leaf.example.com
```

</ScopedBlock>
<ScopedBlock scope={["cloud"]}>

Once you have appended the new text to your OpenSSH client configuration file,
log in to a Node in your Teleport cluster:

```code
# See which Nodes are available to access
$ tsh ls
Node Name        Address    Labels 
---------------- ---------- ------ 
node1 ⟵ Tunnel
# Use your Node's name as a subdomain of your Teleport Cloud tenant domain.   
$ ssh user@node1.mytenant.teleport.sh
```

This will connect to the node `node1` on the `mytenant.teleport.sh` cluster. This
name does not need to be DNS accessible as the connection will be routed through
your Teleport Proxy Service.

If any Trusted Clusters exist, they are also configured:

```code
$ ssh user@node2.mytenant.teleport.sh
```

When connecting to Nodes with Teleport daemons running on non-standard ports
(other than `3022`), a port may be specified:

```code
$ ssh -p 4022 user@node3.mytenant.teleport.sh
```

</ScopedBlock>

<Admonition
  type="tip"
  title="Note"
>
  Teleport uses OpenSSH certificates instead of keys, which means you cannot ordinarily connect to a Teleport Node by IP address. You have to connect by
  DNS name. This is because OpenSSH ensures the DNS name of the Node you are connecting to is listed under the `Principals` section of the OpenSSH certificate to verify you are connecting to the correct Node.
</Admonition>