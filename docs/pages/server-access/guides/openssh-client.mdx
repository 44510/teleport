---
title: Using Teleport with OpenSSH Clients
description: How to use Teleport on legacy systems with OpenSSH clients.
videoBanner: x0eYFUEIOrM
---

Teleport is a standards-compliant SSH proxy and can work in environments that
use legacy SSH implementations, such as OpenSSH, to access infrastructure.

In this guide, we will explain how to configure the OpenSSH client `ssh` to log
in to Nodes inside a Teleport cluster.

Using Teleport with OpenSSH has the advantage of getting you up and running, but
in the long run, we would recommend replacing `sshd` with `teleport`. We've
outlined our reasoning in
[OpenSSH vs Teleport SSH for Servers?](https://gravitational.com/blog/openssh-vs-teleport/).

## Prerequisites

- OpenSSH version 6.9 or above on your local machine. View your OpenSSH version
  with the command:
  
  ```code
  $ ssh -V
  ```

  {/* TODO: The instruction below may complicate things--maybe just encourage users
  to create a config file with a nonstandard name for this tutorial and specify it
   when running SSH commands? */}

  You'll be editing your OpenSSH client configuration, so you may want to run
  the OpenSSH client from a local container or virtual machine.

(!docs/pages/includes/edition-prereqs-tabs.mdx!)


- A Linux host where you will install and run a Teleport Node.

(!docs/pages/includes/tctl.mdx!)

## Step 1/3. Prepare your Node

On the host where you will run your Teleport Node, follow the instructions for
your environment to install Teleport.

(!docs/pages/includes/install-linux.mdx!)

<ScopedBlock scope="cloud">On your local machine, use</ScopedBlock><ScopedBlock
scope={["oss", "enterprise"]}>On the host that runs the Teleport Auth Service,
use</ScopedBlock> the `tctl` tool to generate an invite token that your Node
will use to join the cluster. In the following example, a new token is created
with a TTL of five minutes:

```code
# Generate a short-lived invitation token for a new node:
$ tctl nodes add --ttl=5m --roles=node
# The invite token: (=presets.tokens.first=)
# You can also list all generated non-expired tokens:
$ tctl tokens ls
# Token                            Type            Expiry Time
# ------------------------         -----------     ---------------
# (=presets.tokens.first=)         Node            25 Sep 18 00:21 UTC
```

On the host where you will run your Node, execute the following commands.

Assign your invite token and the
address of your <ScopedBlock scope="cloud">Teleport Cloud
tenant</ScopedBlock><ScopedBlock scope={["oss", "enterprise"]}>Teleport Auth
Service</ScopedBlock> to environment variables:

<ScopedBlock scope={["oss", "enterprise"]}>

```code
$ ADDR=tele.example.com:3025
$ TOKEN=<your token from above>
```

</ScopedBlock>
<ScopedBlock scope={["cloud"]}>

```code
$ ADDR=mytenant.teleport.sh:443
$ TOKEN=<your token from above>
```

</ScopedBlock>

Start Teleport with the invite token:

```code
$ sudo teleport start \
  --auth-server=${ADDR?} \
  --roles=node \
  --token=${TOKEN?}
```

Verify that your Node has started by running `tsh ls` on your local machine:

```code
$ tsh ls
Node Name        Address    Labels 
---------------- ---------- ------ 
ip-172-30-50-106 ⟵ Tunnel          
```

## Step 2/3. Generate an SSH client configuration

{/* TODO: Double-check this for accuracy. Maybe use the original phrasing?

Teleport supports SSH subsystems and includes a `proxy` subsystem that can be
-used like `netcat` is with `ProxyCommand` to connect through a jump host.

*/}

You will need to configure your OpenSSH client to connect to your Teleport cluster,
then connect to the Node.

You can generate an OpenSSH client configuration either automatically with `tsh`
or manually by editing your OpenSSH configuration file.

In either case, make sure you are running OpenSSH's `ssh-agent` and have logged
in to your Teleport cluster:

<ScopedBlock scope={["oss","enterprise"]}>

```code
$ eval `ssh-agent`
$ tsh --proxy=root.example.com --user=myuser@example.com login
```

</ScopedBlock>
<ScopedBlock scope={["cloud"]}>

```code
$ eval `ssh-agent`
$ tsh --proxy=mytenant.teleport.sh --user=myuser@example.com login
```

</ScopedBlock>

The `ssh-agent` command prints additional commands to export the `SSH_AUTH_SOCK`
and `SSH_AGENT_PID` environment variables. These variables allow OpenSSH clients
to find the SSH agent. Running `ssh-agent` with `eval` executes these commands.

<Tabs>
<TabItem label="Automatic Setup">

  <Notice type="note">

  Automatic OpenSSH client configuration is supported on Linux and macOS as of
  Teleport 7.0 and on Windows as of Teleport 7.2.

  </Notice>

On your local machine, run the following `tsh` command. This will print the
necessary configuration to connect to a Node using the standard OpenSSH client:

```code
$ tsh config
```

If you are using Trusted Clusters, this will print an OpenSSH client
configuration block for the root cluster and all currently known leaf clusters.

Append this to your local OpenSSH config file (usually `~/.ssh/config`) using
your text editor of choice.

<Details title="Using PowerShell on Windows?" opened={false}>

  If using PowerShell on Windows, note that normal shell redirection may write
  the file with the incorrect encoding. To ensure it's written properly, try the
  following:

  ```code
  $ tsh.exe config | out-file .ssh\config -encoding utf8 -append
  ```

</Details>

<ScopedBlock scope={["oss", "enterprise"]}>

Once you have appended the new text to your OpenSSH client configuration file,
log in to any Node in your Teleport cluster:

```code
# See which Nodes are available to access
$ tsh ls
Node Name        Address    Labels 
---------------- ---------- ------ 
node1 ⟵ Tunnel   
$ ssh user@node1.root.example.com
```

This will connect to the node `node1` on the `root.example.com` cluster. This
name does not need to be DNS accessible as the connection will be routed through
your Teleport Proxy Service.

If any Trusted Clusters exist, they are also configured:

```code
$ ssh user@node2.leaf.example.com
```

When connecting to Nodes with Teleport daemons running on non-standard ports
(other than `3022`), a port may be specified:

```code
$ ssh -p 4022 user@node3.leaf.example.com
```

</ScopedBlock>
<ScopedBlock scope={["cloud"]}>

Once you have appended the new text to your OpenSSH client configuration file,
log in to any Node in your Teleport cluster:

```code
# See which Nodes are available to access
$ tsh ls
Node Name        Address    Labels 
---------------- ---------- ------ 
node1 ⟵ Tunnel   
$ ssh user@node1.mytenant.teleport.sh
```

This will connect to the node `node1` on the `mytenant.teleport.sh` cluster. This
name does not need to be DNS accessible as the connection will be routed through
your Teleport Proxy Service.

If any Trusted Clusters exist, they are also configured:

```code
$ ssh user@node2.mytenant.teleport.sh
```

When connecting to Nodes with Teleport daemons running on non-standard ports
(other than `3022`), a port may be specified:

```code
$ ssh -p 4022 user@node3.mytenant.teleport.sh
```

</ScopedBlock>


<Admonition
  type="tip"
  title="Automatic OpenSSH and Multiple Clusters"
>

  If you switch between multiple Teleport Proxy Servers, you'll need to re-run
  `tsh config` for each to generate the cluster-specific configuration.

  Similarly, if Trusted Clusters are added or removed, be sure to re-run the
  above command and replace the previous configuration.

</Admonition>

</TabItem>
<TabItem label="Manual Setup">

On your client machine, you need to import the public key of Teleport's host
certificate. This will allow your OpenSSH client to verify that host certificates
are signed by Teleport's trusted host CA:

```code
$ tctl auth export --type=host > teleport_host_ca.pub

# On the machine where you want to run the ssh client
$ cat teleport_host_ca.pub >> ~/.ssh/known_hosts
```

If you have multiple Teleport clusters, you have to export and set up these
certificate authorities for each cluster individually.

<ScopedBlock scope={["oss", "enterprise"]}>

<Admonition
  type="tip"
  title="OpenSSH and Trusted Clusters"
>
  If you use [Recording Proxy Mode](../../architecture/proxy.mdx) and [Trusted Clusters](../../setup/admin/trustedclusters.mdx),
  you need to set up the certificate authority from
  the root cluster to match all Nodes, even those that belong to leaf
  clusters. 
  
  For example, if your Node naming scheme is `*.root.example.com`,
  `*.leaf1.example.com`, `*.leaf2.example.com`, then the
  `@certificate-authority` entry should match `*.example.com` and use the CA
  from the root Auth Server only.
</Admonition>

</ScopedBlock>

<ScopedBlock scope={["oss", "enterprise"]}>

Lastly, configure the OpenSSH client to use the Teleport Proxy Service when connecting
to Nodes with matching names. Edit `~/.ssh/config` for your user or
`/etc/ssh/ssh_config` for global changes:

```txt
# root.example.com is the jump host (Proxy Service). Credentials will be
# obtained from the SSH agent.
Host root.example.com
    HostName 192.168.1.2
    Port 3023

# Connect to Nodes in the root.example.com cluster through the jump
# host (Proxy Service). Credentials will be obtained from the
# SSH agent.
Host *.root.example.com
    HostName %h
    Port 3022
    ProxyCommand tsh proxy ssh %r@%h:%p

# Connect to Nodes within a Trusted Cluster with the name "leaf1.example.com".
Host *.leaf1.example.com
   HostName %h
   Port 3022
   ProxyCommand tsh proxy ssh --cluster=leaf1.example.com %r@%h:%p
```

</ScopedBlock>
<ScopedBlock scope={["cloud"]}>

Lastly, configure the OpenSSH client to use the Teleport Proxy Service when connecting
to Nodes with matching names. Edit `~/.ssh/config` for your user or
`/etc/ssh/ssh_config` for global changes:

```txt
# mytenant.teleport.sh is the jump host (Proxy Service). Credentials will be
# obtained from the SSH agent.
Host mytenant.teleport.sh
    HostName 192.168.1.2
    Port 3023

# Connect to Nodes in the mytenant.teleport.sh cluster through the jump
# host (Proxy Service). Credentials will be obtained from the
# SSH agent.
Host *.mytenant.teleport.sh
    HostName %h
    Port 3022
    ProxyCommand tsh proxy ssh %r@%h:%p

# Connect to Nodes within a Trusted Cluster with the name "leaf1.mytenant.teleport.sh".
Host *.mytenant.teleport.sh
   HostName %h
   Port 3022
   ProxyCommand tsh proxy ssh --cluster=mytenant.teleport.sh %r@%h:%p
```

</ScopedBlock>

</TabItem>
</Tabs>

## Step 3 /. Connect to the Node

<ScopedBlock scope="cloud">

When everything is configured properly, you can use SSH to connect to any Node
behind `mytenant.teleport.sh`:

```code
$ ssh root@database.root.mytenant.teleport.sh
```

</ScopedBlock>
<ScopedBlock scope={["oss", "enterprise"]}>

When everything is configured properly, you can use SSH to connect to any Node
behind `root.example.com`:

```code
$ ssh root@database.root.example.com
```
</ScopedBlock>

<Admonition
  type="tip"
  title="Note"
>
  Teleport uses OpenSSH certificates instead of keys, which means you cannot ordinarily connect to a Teleport Node by IP address. You have to connect by
  DNS name. This is because OpenSSH ensures the DNS name of the Node you are connecting to is listed under the `Principals` section of the OpenSSH certificate to verify you are connecting to the correct Node.
</Admonition>

To connect to the OpenSSH server via `tsh`, add `--port=<ssh port>` with the `tsh ssh` command:

<ScopedBlock scope={["oss","enterprise"]}>

Example `tsh ssh` command to access `database.work.example.com` as `root` with
an OpenSSH server on port 22 via `tsh`:

```code
$ tsh ssh --port=22 dev@database.root.example.com
```

</ScopedBlock>
<ScopedBlock scope={["cloud"]}>

Example `tsh ssh` command to access `database.work.mytenant.teleport.sh` as `root` with
an OpenSSH server on port 22 via `tsh`:

```code
$ tsh ssh --port=22 dev@database.root.mytenant.teleport.sh
```

</ScopedBlock>

<Admonition
  type="warning"
  title="Warning"
>
  The principal/username (`dev@` in the example above) being used to connect must be listed in the Teleport user/role configuration.
</Admonition>