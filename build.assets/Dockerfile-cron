FROM alpine AS download

WORKDIR /tmp

# Install dependencies.
RUN apk --update --no-cache add curl

# Download the repo signing key
RUN curl https://apt.releases.teleport.dev/gpg \
  -o /tmp/teleport-archive-keyring.asc

FROM ubuntu:20.04 AS teleport

ARG MAJOR_VERSION
ARG PACKAGE_NAME

# Copy the signing key
COPY --from=download /tmp/teleport-archive-keyring.asc /usr/share/keyrings/teleport-archive-keyring.asc

# Install dependencies
RUN apt-get update && \
    DEBIAN_FRONTEND=noninteractive apt-get upgrade -y && \
    DEBIAN_FRONTEND=noninteractive apt-get install --no-install-recommends -y ca-certificates dumb-init libelf1 && \
    update-ca-certificates && \
    # Add the Teleport APT repo
    . /etc/os-release && \
    echo "deb [signed-by=/usr/share/keyrings/teleport-archive-keyring.asc] \
        https://apt.releases.teleport.dev/${ID?} ${VERSION_CODENAME?} stable/$MAJOR_VERSION" \
        | tee /etc/apt/sources.list.d/teleport.list > /dev/null && \
    # Install Teleport
    apt-get update && \
    DEBIAN_FRONTEND=noninteractive apt-get install --no-install-recommends -y $PACKAGE_NAME && \
    # Cleanup
    apt-get -y clean && \
    rm -rf /var/lib/apt/lists/*