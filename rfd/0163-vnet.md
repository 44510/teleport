---
authors: Nic Klaassen (nic@goteleport.com), Rafał Cieślak (rafal.cieslak@goteleport.com)
state: draft
---

# RFD 163 - Teleport VNet

## What

Teleport VNet creates a virtual subnet with DNS that automatically proxies TCP
connections to Teleport apps over fully authenticated virtual tunnels.

## Why

Today Teleport users have to manually create tunnels to access private services
and apps.
This creates manual overhead and does not work in many use-cases, for example,
when API endpoints are hardcoded.
Teleport VNet removes the need of manual management of tunnels for accessing
services by creating a virtual subnet and DNS that manage connections
automatically.

## Details

### Security

### UX

VNet is available in both tsh and Teleport Connect. This section focuses mostly on VNet integration
in Teleport Connect, with a short subsection on VNet in tsh at the end.

Attempting to connect to a TCP app opens the VNet tab instead. When the VNet app is opened this way,
it gives the user an option to either start VNet or open a standard local proxy instead.

Web apps continue to launch through the proxy service. The three dot menu next to web apps gains a
new action called "Open through VNet". If VNet is running, it opens the app VNet address in the
browser. If VNet is not running, it opens the VNet tab saying "You can open dumper and other apps
through VNet". After VNet starts, the message becaumes "dumper is available at
dumper.teleport.private" with either a link or a button to open the address in the browser.

TODO: Dedicated button in top left with status indicator.

#### Lifecycle

The first version of VNet integration in Connect is going to behave similarly to Connect My
Computer. After the user starts VNet and until they explicitly stop it, VNet will start
automatically when launching the app. It will prompt for password for admin privileges on each
start. This requires the given system user to be an admin, disqualifying cases where the user is
just a standard macOS account.

Unfortunately, it appears that since Sonoma `osascript -e "do shell script … with administrator
privileges"` no longer accepts Touch ID, requiring the user to provide the password. We assume that
typically the user is going to start VNet and then just leave it running, somewhat negating the
downside of having to enter credentials on each start.

##### Considered alternatives

Tying the lifecycle of VNet to the lifecycle of Connect gets us past the problem of needing root
privileges to create a TUN device and lets us focus on validating VNet as a tool. However, there is
a couple of different approaches we could take which offer better UX at the cost of development
time.

###### Launch VNet on system start

Doing so would require some kind of persistent UI that is also launched on system start, think an
icon in the Menu Bar. The UI would need to enable the user to manage the state of VNet and provide a
way to refresh expired certs. Connect could support headless mode where it does not open the main
window automatically and instead launches a separate frontend app which handles relogin.

###### Ask for admin privileges just once

The recommended way for an unprivileged app to use privileged APIs is to use [`SMJobBless`](https://developer.apple.com/documentation/servicemanagement/smjobbless(_:_:_:_:)).
`SMJobBless` allows the unprivileged app to add a privileged helper to launchd. That helper can be
launched from the unprivileged app whenever needed, without having to enter credentials each time.

Using `SMJobBless` requires a lot of extra setup. It needs a separate executable that acts as the
privileged helper and proper configuration of three separate `.plist` files. [The privileged helper
can be called by any process in the system](https://obdev.at/blog/what-we-have-learned-from-a-vulnerability/),
thus requiring some form of verification of the client. This requires either communicating over XPC
through Objective-C or Swift and verifying client signature or figuring a way of securely
communicating over gRPC. It's unclear if it also requires an uninstaller for a proper cleanup of the
privileged helper, see [the mention of "clean up" in How Ventura is changing Login and Background
Items](https://eclecticlight.co/2023/02/16/how-ventura-is-changing-login-and-background-items/).

The main benefit is the aforementioned single prompt for root privileges. Possibly it also means
that VNet could be made to work in an environment where the system user is just a standard user.

* [Docs for an example use case of `SMJobBless`](https://developer.apple.com/library/archive/samplecode/EvenBetterAuthorizationSample/Listings/Read_Me_About_EvenBetterAuthorizationSample_txt.html)
* [An example project using `SMJobBless`](https://github.com/aronskaya/smjobbless)

#### tsh integration

TODO

### Proto Specification

### Backward Compatibility

### Audit Events

### Observability

### Product Usage

### Test Plan
