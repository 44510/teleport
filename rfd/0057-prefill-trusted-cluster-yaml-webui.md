---
authors: Matheus Battirola (matheus.battirola@goteleport.com)
state: draft
---

# RFD 57 - Prefill Trusted Cluster YAML file from the Web UI

## What

Improve UX of adding a trusted cluster by making the Web UI provide a YAML file with some of the values already filled for the user.

## Why

The web interface doesn’t do much to help users add trusted clusters, making the current UX confusing.

## Context

Adding a [trusted cluster](https://goteleport.com/docs/setup/admin/trustedclusters/) demands actions from the administrators of both root and leaf clusters.

The root admin must provide data and generate a join token, while the leaf must run `tctl create` with the data provided.

### Current State

Currently, in the `Trust` screen, the user sees a button that says `CONNECT TO ROOT CLUSTER`. Once clicked, the user gets a YAML file with placeholder values that they are supposed to replace.

This is the YAML file provided by the web UI:

```yaml
#
# Example resource for a trusted cluster with RBAC
#
# IMPORTANT: only one field (enabled) can be changed after a cluster is created.
#
kind: trusted_cluster
version: v2
metadata:
  # the trusted cluster name MUST match the 'cluster_name' setting of the root cluster.
  name: name-of-root-cluster
spec:
  # this field allows to create tunnels that are disabled, but can be enabled later.
  # this is the only field that can be changed later.
  enabled: true
  # the token expected by the "root" cluster:
  # This can be a static token from the root cluster https://goteleport.com/docs/trustedclusters/#static-join-tokens
  # or a dynamic token generated by the root cluster https://goteleport.com/docs/trustedclusters/#dynamic-join-tokens
  token: secret-token-from-root-cluster
  # the address in 'host:port' form of the reverse tunnel listening port on the
  # "root" proxy server:
  tunnel_addr: root-proxy.example.com:3024
  # the address in 'host:port' form of the web listening port on the
  # "root" proxy server:
  web_proxy_addr: root-proxy.example.com:443
  # RBAC for trusted clusters: it says that the users who have the role 'access'
  # on a root cluster will be mapped to the local role 'guest'
  role_map:
    - local: [guest]
      remote: access
```

To add a root cluster, the leaf admin needs the following information from the root:

- `token`: generated by running `tctl tokens add --type=trusted_cluster` on the **root** or by having a static token on `teleport.yaml` of the root’s auth service.
- `tunnel_addr`: this can be found by making an HTTP request to root proxy `/webapi/ping`, but most users are not likely to know or be able to do that.
- `web_proxy_addr`: the user needs to know or ask the root admin.
- `role_map`: the user needs to know the roles in the remote (root) cluster and decide how to map to theirs.

Unless the user has access to the root cluster, they are not likely to know most of this information and will have to ask the root’s administrator. Even if the the same person has access to both clusters, it may be tough to fill some of the fields.

Then, after saving the YAML to a local file, the user can run `tctl create trusted-cluster.yaml` to add the root cluster, or use the web UI to do that.

The current process only sees things by the perspective of the leaf, not the root, which can be confusing to people looking to add a **leaf**.

### Proposal

Differentiate in the UI between adding a **leaf** and a **root** cluster and fill the YAML with available data.

The button on `Trust` screen currently has the label `CONNECT TO ROOT CLUSTER`. We can change it to `CONNECT CLUSTER` and prompt the user to connect a `Leaf` or `Root` cluster.

Then, have different flows to each use case:

**Adding a Leaf Cluster from the root:**

When trying to add a `Leaf`, it should be provided to the user a filled YAML with instructions on how to add the cluster.

Here are the fields that the system needs to fill, and how it can get them:

- `metadata.name`: is the name of the current cluster, already available to the web UI
- `spec.enabled`: can be `true` by default
- `spec.token`: currently, there is [an endpoint](https://github.com/gravitational/teleport.e/blob/e9c0cb35467bc9cae40f2b55ca16cbc3e0ff6f07/lib/web/plugin.go#L88) on teleport enterprise to generate tokens for apps and nodes. We can make a new endpoint to add generate tokens for a trusted cluster to use here. For OSS, we can add the instruction to run `tctl tokens add --type=trusted_cluster` and get the token instead.
- `spec.tunnel_addr`: can be added in `GRV_CONFIG` which is set from the web server into the web page.

The user would need to set the `role_map` field, with the provided instructions. We could prefill with all the roles available in the root cluster:

```yaml
# RBAC for trusted clusters: it says that the users who have the remote role
# on a root cluster will be mapped to the corresponding local role
role_map:
  - local: [EDIT_HERE]
    remote: editor
  - local: [EDIT_HERE]
    remote: auditor
```

With this YAML, it should be explained to the user that they can send it over the admin of the leaf to run `tctl create trusted-cluster.yaml`

We can facilitate this step with a message the user can copy and send via e-mail/message app. Here is an example:

```plaintext
Add my cluster as a trusted cluster.

Please save the yaml file and edit the `role_map` field, then run:

$ tctl create trusted-cluster.yaml
The token is valid until (timestamp)
```

**Adding a Root Cluster from the Leaf Cluster:**

When adding a **root** cluster, most of the data needs to come from the root. This can’t be done without cooperation from someone with access to the root cluster.

We can't set most of the information from the leaf. This should be explained to the user and suggested that he ask for the auto-generate YAML from the root's web UI:

```plaintext
TIP:
You can ask for the root cluster administrator to auto-generate the YAML file from their web interface:
1. Open the web interface
2. Go To Clusters > Trust
3. Click `CONNECT CLUSTER`
4. Select `ADD LEAF CLUSTER`
5. Send the filled YAML file

```

If the user still wants to fill the YAML file manually, we can use the currently provided YAML with the field `role_map` partially filled with the roles on the leaf:

```yaml
# RBAC for trusted clusters: it says that the users who have the remote role
# on a root cluster will be mapped to the corresponding local role
role_map:
  - local: editor
    remote: [EDIT_HERE]
  - local: auditor
    remote: [EDIT_HERE]
```

And instructions on how to create the token, which are missing currently:

```plaintext
To generate the join token, run the following command against the root cluster

$ tctl tokens add --type=trusted_cluster --ttl=1h
```
